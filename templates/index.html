<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Resume Evaluator</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #6c757d;
            --accent: #06d6a0;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #06d6a0;
            --warning: #ffd166;
            --danger: #ef476f;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #495057;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .card:hover {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(67, 97, 238, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(67, 97, 238, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: var(--secondary);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .loading-spinner {
            border: 3px solid rgba(67, 97, 238, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tab-button {
            padding: 12px 20px;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: var(--secondary);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .tab-button:hover:not(.active) {
            color: var(--primary-dark);
            background-color: rgba(67, 97, 238, 0.03);
        }
        
        .score-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .ats-score {
            background: linear-gradient(135deg, #4361ee 0%, #3a56d4 100%);
            color: white;
        }
        
        .hr-score {
            background: linear-gradient(135deg, #06d6a0 0%, #05c091 100%);
            color: white;
        }
        
        .prose {
            color: #374151;
            line-height: 1.7;
        }
        
        .prose h4 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--dark);
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        .prose ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .prose li {
            margin-bottom: 0.5rem;
        }
        
        .candidate-card {
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }
        
        .candidate-card:hover {
            border-left-color: var(--primary-dark);
            transform: translateX(4px);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-processing {
            background-color: #ffd166;
        }
        
        .status-complete {
            background-color: #06d6a0;
        }
        
        .status-error {
            background-color: #ef476f;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pill {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .pill-primary {
            background-color: #e0e7ff;
            color: var(--primary-dark);
        }
        
        .pill-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .pill-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .strength-item, .weakness-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
        }
        
        .strength-item {
            background-color: #f0f9ff;
            border-left: 4px solid #0ea5e9;
        }
        
        .weakness-item {
            background-color: #fef2f2;
            border-left: 4px solid #ef4444;
        }
        
        .strength-icon, .weakness-icon {
            margin-right: 12px;
            font-size: 1.2rem;
            margin-top: 2px;
        }
        
        .strength-icon {
            color: #0ea5e9;
        }
        
        .weakness-icon {
            color: #ef4444;
        }
        
        .candidate-header {
            background: linear-gradient(90deg, #f8f9fa 0%, #f1f3f5 100%);
            border-bottom: 1px solid #e9ecef;
            padding: 20px;
        }
        
        .evaluation-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .skill-meter {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .skill-level {
            height: 100%;
            border-radius: 4px;
        }
        
        .skill-high {
            background: linear-gradient(90deg, #06d6a0 0%, #05c091 100%);
            width: 85%;
        }
        
        .skill-medium {
            background: linear-gradient(90deg, #ffd166 0%, #fdc43f 100%);
            width: 65%;
        }
        
        .skill-low {
            background: linear-gradient(90deg, #ef476f 0%, #e81347 100%);
            width: 40%;
        }
        
        .match-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .match-clear {
            background-color: #06d6a0;
        }
        
        .match-partial {
            background-color: #ffd166;
        }
        
        .match-none {
            background-color: #ef476f;
        }
        
        .question-item {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            background-color: white;
            border-left: 4px solid #4361ee;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .recommendation-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #4361ee;
        }
        
        .justification-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .rotate-180 {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">
    <div class="container mx-auto">
        <div class="card p-6 md:p-8 lg:p-10 mb-8">
            <header class="text-center mb-10">
                <div class="inline-flex items-center justify-center w-20 h-20 gradient-bg text-white rounded-full mb-4">
                    <i class="fas fa-robot text-3xl"></i>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">AI-Powered Resume Evaluation System</h1>
                <p class="text-lg text-slate-600 max-w-2xl mx-auto">Intelligent candidate assessment with detailed scoring and recommendations</p>
            </header>

            <section class="grid md:grid-cols-2 gap-8 mb-10">
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4 text-slate-800 flex items-center">
                        <i class="fas fa-clipboard-list text-blue-500 mr-3"></i>
                        Job Description
                    </h2>
                    <textarea id="jobDescription" rows="10" class="w-full p-4 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 resize-none" placeholder="Paste the job description here..."></textarea>
                    
                    <div class="mt-6">
                        <label for="daysFilter" class="block text-sm font-medium text-slate-700 mb-2">Time Range for Resumes</label>
                        <select id="daysFilter" class="w-full p-3 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 bg-white">
                            <option value="1">Last 24 hours</option>
                            <option value="7">Last week</option>
                            <option value="14">Last 2 weeks</option>
                            <option value="30" selected>Last month</option>
                            <option value="90">Last 3 months</option>
                        </select>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4 mt-6">
                        <button id="fetchButton" class="btn-primary flex-1 flex justify-center items-center gap-2">
                            <i class="fas fa-sync-alt"></i>
                            <span>Fetch Resumes from Gmail</span>
                        </button>
                        <a href="/authenticate" id="authButton" class="btn-secondary flex-1 flex justify-center items-center gap-2">
                            <i class="fas fa-lock"></i>
                            <span>Re-authenticate</span>
                        </a>
                    </div>
                    
                    <div id="statusMessage" class="mt-4 text-center p-3 rounded-lg"></div>
                </div>
                
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4 text-slate-800 flex items-center">
                        <i class="fas fa-info-circle text-blue-500 mr-3"></i>
                        Instructions
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0 h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center mt-1">
                                <span class="text-blue-700 text-sm font-bold">1</span>
                            </div>
                            <div class="ml-3">
                                <p class="text-slate-700 font-medium">Enter the job description</p>
                                <p class="text-slate-500 text-sm mt-1">Include required skills, experience level, and responsibilities</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <div class="flex-shrink-0 h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center mt-1">
                                <span class="text-blue-700 text-sm font-bold">2</span>
                            </div>
                            <div class="ml-3">
                                <p class="text-slate-700 font-medium">Fetch resumes from Gmail</p>
                                <p class="text-slate-500 text-sm mt-1">The system will search for resumes in your Gmail account</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <div class="flex-shrink-0 h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center mt-1">
                                <span class="text-blue-700 text-sm font-bold">3</span>
                            </div>
                            <div class="ml-3">
                                <p class="text-slate-700 font-medium">Authenticate if needed</p>
                                <p class="text-slate-500 text-sm mt-1">A browser window will open for Google login if required</p>
                            </div>
                        </div>
                        
                        <div class="flex items-start">
                            <div class="flex-shrink-0 h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center mt-1">
                                <span class="text-blue-700 text-sm font-bold">4</span>
                            </div>
                            <div class="ml-3">
                                <p class="text-slate-700 font-medium">View candidate evaluations</p>
                                <p class="text-slate-500 text-sm mt-1">Analyze scores, recommendations, and send responses</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-amber-50 border-l-4 border-amber-400 text-amber-800 rounded-lg">
                        <p class="font-medium flex items-center">
                            <i class="fas fa-lightbulb mr-2"></i>
                            Pro Tips
                        </p>
                        <ul class="text-sm mt-2 list-disc list-inside">
                            <li>The more detailed the job description, the better the evaluation accuracy</li>
                            <li>Include specific technologies, years of experience, and soft skills needed</li>
                            <li>Use the time range filter to focus on recent applications</li>
                        </ul>
                    </div>
                </div>
            </section>

            <section id="candidateResults" class="mt-12">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800 flex items-center">
                        <i class="fas fa-users mr-3"></i>
                        Candidate Evaluations
                    </h2>
                    <div id="resultsCount" class="text-slate-500 text-sm hidden">
                        <span id="countValue">0</span> candidates processed
                    </div>
                </div>
                
                <div id="resultsContainer">
                    <div id="initialPrompt" class="text-center py-16 px-4 rounded-lg bg-slate-50 border-2 border-dashed border-slate-200">
                        <i class="fas fa-file-invoice text-5xl text-slate-300 mb-4"></i>
                        <p class="text-slate-400 text-lg font-medium">Enter a job description and click "Fetch Resumes" to begin evaluation</p>
                        <p class="text-slate-400 mt-2">The system will analyze resumes from your Gmail account</p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const jobDescription = document.getElementById('jobDescription');
            const fetchButton = document.getElementById('fetchButton');
            const daysFilter = document.getElementById('daysFilter');
            const statusMessage = document.getElementById('statusMessage');
            const resultsContainer = document.getElementById('resultsContainer');
            const initialPrompt = document.getElementById('initialPrompt');
            const resultsCount = document.getElementById('resultsCount');
            const countValue = document.getElementById('countValue');
            
            const cachedJobDesc = localStorage.getItem('jobDescription');
            if (cachedJobDesc) {
                jobDescription.value = cachedJobDesc;
            }

            fetchButton.addEventListener('click', async () => {
                const jdValue = jobDescription.value.trim();
                const daysValue = daysFilter.value;
                
                if (!jdValue) {
                    statusMessage.innerHTML = '<div class="bg-red-50 text-red-700 p-3 rounded-lg"><i class="fas fa-exclamation-circle mr-2"></i> Please enter a job description to continue.</div>';
                    return;
                }

                localStorage.setItem('jobDescription', jdValue);

                initialPrompt.classList.add('hidden');
                resultsContainer.innerHTML = '';
                resultsCount.classList.add('hidden');
                
                statusMessage.innerHTML = `
                    <div class="flex items-center justify-center gap-3 bg-blue-50 text-blue-700 p-4 rounded-lg">
                        <div class="loading-spinner"></div>
                        <span>Fetching and analyzing resumes...</span>
                    </div>
                `;

                try {
                    const response = await fetch('/fetch_resumes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ job_description: jdValue, days_filter: parseInt(daysValue) })
                    });

                    if (response.status === 401) {
                        statusMessage.innerHTML = '<div class="bg-red-50 text-red-700 p-3 rounded-lg"><i class="fas fa-exclamation-triangle mr-2"></i> Authentication required. Please click "Re-authenticate" to log in with Google.</div>';
                        return;
                    }

                    const data = await response.json();

                    if (data.message) {
                        statusMessage.innerHTML = `<div class="bg-yellow-50 text-yellow-700 p-3 rounded-lg"><i class="fas fa-info-circle mr-2"></i> ${data.message}</div>`;
                    } else if (data.candidates && data.candidates.length > 0) {
                        renderCandidates(data.candidates);
                        countValue.textContent = data.candidates.length;
                        resultsCount.classList.remove('hidden');
                        statusMessage.innerHTML = `<div class="bg-green-50 text-green-700 p-3 rounded-lg"><i class="fas fa-check-circle mr-2"></i> Successfully analyzed ${data.candidates.length} resumes.</div>`;
                    } else {
                        statusMessage.innerHTML = '<div class="bg-red-50 text-red-700 p-3 rounded-lg"><i class="fas fa-exclamation-triangle mr-2"></i> No suitable resumes found or an error occurred during processing.</div>';
                    }

                } catch (error) {
                    console.error("Error fetching resumes:", error);
                    statusMessage.innerHTML = '<div class="bg-red-50 text-red-700 p-3 rounded-lg"><i class="fas fa-exclamation-triangle mr-2"></i> Error connecting to the backend service. Please check your connection and try again.</div>';
                }
            });

            async function sendEmail(emailType, candidate) {
                statusMessage.innerHTML = `
                    <div class="flex items-center justify-center gap-3 bg-blue-50 text-blue-700 p-4 rounded-lg">
                        <div class="loading-spinner"></div>
                        <span>Sending ${emailType === 'accept' ? 'acceptance' : 'rejection'} email to ${candidate.name || candidate.email}...</span>
                    </div>
                `;

                try {
                    const jdValue = jobDescription.value.trim();
                    const response = await fetch('/send_email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: candidate.email,
                            name: candidate.name,
                            job_description: jdValue,
                            type: emailType
                        })
                    });
                    const data = await response.json();
                    if (data.success) {
                        statusMessage.innerHTML = `<div class="bg-green-50 text-green-700 p-3 rounded-lg"><i class="fas fa-check-circle mr-2"></i> ${data.message}</div>`;
                    } else {
                        statusMessage.innerHTML = `<div class="bg-red-50 text-red-700 p-3 rounded-lg"><i class="fas fa-exclamation-circle mr-2"></i> ${data.message}</div>`;
                    }
                } catch (error) {
                    statusMessage.innerHTML = `<div class="bg-red-50 text-red-700 p-3 rounded-lg"><i class="fas fa-exclamation-circle mr-2"></i> Failed to send email. Please check your network connection and try again.</div>`;
                }
            }

            function formatTextWithMarkdown(text) {
                if (!text) return '';
                
                // Convert bold text
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                // Convert lists
                text = text.replace(/^-\s+(.*)$/gm, '<li>$1</li>');
                text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
                
                // Convert line breaks
                text = text.replace(/\n/g, '<br>');
                
                return text;
            }

            function parseInterviewQuestions(text) {
                if (!text) return '';
                
                const questions = text.split(/\d+\.\s/).filter(q => q.trim() !== '');
                let html = '';
                
                questions.forEach((question, index) => {
                    const parts = question.split('**Match level:**');
                    const questionText = parts[0].trim();
                    let matchLevel = '';
                    let explanation = '';
                    
                    if (parts.length > 1) {
                        const matchParts = parts[1].split('**Explanation:**');
                        matchLevel = matchParts[0].trim();
                        explanation = matchParts.length > 1 ? matchParts[1].trim() : '';
                    }
                    
                    html += `
                        <div class="question-item">
                            <p class="font-semibold text-slate-800">${index + 1}. ${questionText}</p>
                            ${matchLevel ? `
                                <div class="mt-2 flex items-center">
                                    <span class="match-indicator ${getMatchClass(matchLevel)}"></span>
                                    <span class="text-sm font-medium">${matchLevel}</span>
                                </div>
                            ` : ''}
                            ${explanation ? `
                                <div class="mt-2 text-sm text-slate-600">
                                    <strong>Explanation:</strong> ${explanation}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                return html;
            }
            
            function getMatchClass(level) {
                if (level.toLowerCase().includes('clear')) return 'match-clear';
                if (level.toLowerCase().includes('partial')) return 'match-partial';
                if (level.toLowerCase().includes('none')) return 'match-none';
                return '';
            }

            function renderCandidates(candidates) {
                const container = document.getElementById('resultsContainer');
                container.innerHTML = '';
                
                candidates.forEach((candidate, index) => {
                    const card = document.createElement('div');
                    card.className = 'candidate-card card mb-6 fade-in';
                    card.style.animationDelay = `${index * 0.1}s`;
                    
                    // Header with expand/collapse functionality
                    const header = document.createElement('div');
                    header.className = 'candidate-header cursor-pointer flex justify-between items-center';
                    header.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center mr-4">
                                <i class="fas fa-user text-blue-600"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-slate-800">${candidate.filename}</h3>
                                <p class="text-slate-500 text-sm">
                                    ${candidate.name || 'Unknown Name'} • ${candidate.email || 'No email'} • ${candidate.phone || 'No phone'}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            ${candidate.sections.ats_score !== null ? `
                                <div class="mr-4 text-center">
                                    <div class="text-xs text-slate-500 font-medium">ATS Score</div>
                                    <div class="text-lg font-bold text-blue-600">${candidate.sections.ats_score}/100</div>
                                </div>
                            ` : ''}
                            ${candidate.sections.hr_score !== null ? `
                                <div class="mr-4 text-center">
                                    <div class="text-xs text-slate-500 font-medium">HR Score</div>
                                    <div class="text-lg font-bold text-green-600">${candidate.sections.hr_score}/10</div>
                                </div>
                            ` : ''}
                            <span class="text-slate-400 transition-transform duration-300">
                                <i class="fas fa-chevron-down"></i>
                            </span>
                        </div>
                    `;
                    card.appendChild(header);

                    // Details section (initially hidden)
                    const details = document.createElement('div');
                    details.className = 'p-6 space-y-6 hidden';
                    
                    // Tab container
                    const tabContainer = document.createElement('div');
                    const tabList = document.createElement('div');
                    tabList.className = 'flex overflow-x-auto border-b border-slate-200';
                    tabContainer.appendChild(tabList);

                    const tabContent = document.createElement('div');
                    tabContent.className = 'mt-4';
                    tabContainer.appendChild(tabContent);

                    // Define tabs
                    const tabs = [
                        { id: 'info', title: 'Basic Info', icon: 'user', content: `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h4 class="text-slate-700 font-medium mb-2">Candidate Details</h4>
                                    <p><strong>Name:</strong> ${candidate.name || 'Not available'}</p>
                                    <p><strong>Email:</strong> ${candidate.email || 'Not available'}</p>
                                    <p><strong>Phone:</strong> ${candidate.phone || 'Not available'}</p>
                                </div>
                                <div>
                                    <h4 class="text-slate-700 font-medium mb-2">Email Metadata</h4>
                                    <p><strong>Sender:</strong> ${candidate.sender || 'Unknown'}</p>
                                    <p><strong>Subject:</strong> ${candidate.subject || 'N/A'}</p>
                                    <p><strong>Filename:</strong> ${candidate.filename}</p>
                                </div>
                            </div>
                            <div class="mt-4 prose">${formatTextWithMarkdown(candidate.sections.basic_info)}</div>
                        ` },
                        { id: 'strengths', title: 'Strengths & Weaknesses', icon: 'chart-bar', content: `
                            <div class="evaluation-section">
                                <h4 class="text-slate-800 font-semibold mb-4">Strengths</h4>
                                ${candidate.sections.strengths_weaknesses.includes('- **Strength:**') ? 
                                    candidate.sections.strengths_weaknesses.split('- **Strength:**').slice(1).map(strength => {
                                        const cleanStrength = strength.split('- **Weakness:**')[0].trim();
                                        return `
                                            <div class="strength-item">
                                                <div class="strength-icon"><i class="fas fa-plus-circle"></i></div>
                                                <div>${cleanStrength}</div>
                                            </div>
                                        `;
                                    }).join('') : 
                                    `<div class="prose">${formatTextWithMarkdown(candidate.sections.strengths_weaknesses)}</div>`
                                }
                                
                                <h4 class="text-slate-800 font-semibold mb-4 mt-6">Weaknesses</h4>
                                ${candidate.sections.strengths_weaknesses.includes('- **Weakness:**') ? 
                                    candidate.sections.strengths_weaknesses.split('- **Weakness:**').slice(1).map(weakness => {
                                        const cleanWeakness = weakness.split('- **Strength:**')[0].trim();
                                        return `
                                            <div class="weakness-item">
                                                <div class="weakness-icon"><i class="fas fa-minus-circle"></i></div>
                                                <div>${cleanWeakness}</div>
                                            </div>
                                        `;
                                    }).join('') : 
                                    `<div class="prose">${formatTextWithMarkdown(candidate.sections.strengths_weaknesses)}</div>`
                                }
                            </div>
                        ` },
                        { id: 'summary', title: 'Summary & Justification', icon: 'file-alt', content: `
                            <div class="justification-section">
                                <h4 class="text-slate-800 font-semibold mb-4">HR Summary</h4>
                                <div class="prose">${formatTextWithMarkdown(candidate.sections.hr_summary)}</div>
                                
                                <h4 class="text-slate-800 font-semibold mb-4 mt-6">Justification</h4>
                                <div class="prose">${formatTextWithMarkdown(candidate.sections.justification)}</div>
                            </div>
                        ` },
                        { id: 'recommendation', title: 'Recommendation', icon: 'star', content: `
                            <div class="recommendation-section">
                                <div class="prose">${formatTextWithMarkdown(candidate.sections.recommendation)}</div>
                            </div>
                        ` },
                        { id: 'ats', title: 'Scores', icon: 'calculator', content: `
                            <div class="flex flex-col md:flex-row gap-6 text-center">
                                <div class="p-6 rounded-lg bg-slate-50 flex-1 flex flex-col items-center">
                                    <div class="score-badge ats-score mb-4">
                                        ${candidate.sections.ats_score !== null ? candidate.sections.ats_score : '-'}
                                    </div>
                                    <p class="text-xl font-bold text-slate-800">ATS Score</p>
                                    <p class="text-slate-500 mt-2">Out of 100 points</p>
                                    <div class="skill-meter w-full mt-4">
                                        <div class="skill-level ${candidate.sections.ats_score >= 80 ? 'skill-high' : candidate.sections.ats_score >= 60 ? 'skill-medium' : 'skill-low'}" style="width: ${candidate.sections.ats_score}%"></div>
                                    </div>
                                    <p class="text-sm text-slate-500 mt-4">Measures keyword matching and resume structure</p>
                                </div>
                                <div class="p-6 rounded-lg bg-slate-50 flex-1 flex flex-col items-center">
                                    <div class="score-badge hr-score mb-4">
                                        ${candidate.sections.hr_score !== null ? candidate.sections.hr_score : '-'}
                                    </div>
                                    <p class="text-xl font-bold text-slate-800">HR Score</p>
                                    <p class="text-slate-500 mt-2">Out of 10 points</p>
                                    <div class="skill-meter w-full mt-4">
                                        <div class="skill-level ${candidate.sections.hr_score >= 8 ? 'skill-high' : candidate.sections.hr_score >= 6 ? 'skill-medium' : 'skill-low'}" style="width: ${candidate.sections.hr_score * 10}%"></div>
                                    </div>
                                    <p class="text-sm text-slate-500 mt-4">Measures cultural fit and experience relevance</p>
                                </div>
                            </div>
                        ` },
                        { id: 'interview', title: 'Interview Qs', icon: 'question-circle', content: `
                            ${parseInterviewQuestions(candidate.sections.interview_questions)}
                        ` }
                    ];

                    // Create tabs
                    tabs.forEach((tab, tabIndex) => {
                        const tabButton = document.createElement('div');
                        tabButton.className = `tab-button ${tabIndex === 0 ? 'active' : ''}`;
                        tabButton.innerHTML = `
                            <i class="fas fa-${tab.icon} mr-2"></i>
                            ${tab.title}
                        `;
                        tabButton.onclick = () => {
                            // Deactivate all tabs
                            Array.from(tabList.children).forEach(child => {
                                child.classList.remove('active');
                            });
                            
                            // Hide all tab content
                            Array.from(tabContent.children).forEach(child => {
                                child.classList.add('hidden');
                            });
                            
                            // Activate current tab
                            tabButton.classList.add('active');
                            tabContent.children[tabIndex].classList.remove('hidden');
                        };
                        tabList.appendChild(tabButton);
                        
                        // Create tab content
                        const tabSection = document.createElement('div');
                        tabSection.className = `p-4 ${tabIndex === 0 ? '' : 'hidden'}`;
                        tabSection.innerHTML = tab.content;
                        tabContent.appendChild(tabSection);
                    });

                    details.appendChild(tabContainer);

                    // Action buttons
                    const actions = document.createElement('div');
                    actions.className = 'mt-6 flex flex-col sm:flex-row gap-4';
                    
                    const acceptBtn = document.createElement('button');
                    acceptBtn.className = 'btn-primary flex-1 flex items-center justify-center gap-2';
                    acceptBtn.innerHTML = '<i class="fas fa-check-circle"></i> Send Acceptance Email';
                    acceptBtn.onclick = () => sendEmail('accept', candidate);
                    
                    const rejectBtn = document.createElement('button');
                    rejectBtn.className = 'btn-secondary flex-1 flex items-center justify-center gap-2';
                    rejectBtn.innerHTML = '<i class="fas fa-times-circle"></i> Send Rejection Email';
                    rejectBtn.onclick = () => sendEmail('reject', candidate);
                    
                    actions.appendChild(acceptBtn);
                    actions.appendChild(rejectBtn);
                    details.appendChild(actions);

                    // Toggle details on header click
                    header.addEventListener('click', () => {
                        details.classList.toggle('hidden');
                        const icon = header.querySelector('.fa-chevron-down');
                        icon.classList.toggle('rotate-180');
                    });
                    
                    card.appendChild(details);
                    container.appendChild(card);
                });
            }
        });
    </script>
</body>
</html>